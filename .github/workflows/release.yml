name: Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version type to release'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      pre_release:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  release:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.24.0
          cache: true

      - name: Setup Homebrew cache
        uses: actions/cache@v4
        with:
          path: |
            /opt/homebrew/bin
            /opt/homebrew/lib
            /usr/local/bin
            /usr/local/lib
            ~/Library/Caches/Homebrew
            /home/linuxbrew/.linuxbrew
          key: ${{ runner.os }}-homebrew-${{ hashFiles('script/install_dev_requirement.sh') }}
          restore-keys: |
            ${{ runner.os }}-homebrew-

      - name: Install dependencies
        run: |
          chmod +x script/install_dev_requirement.sh
          chmod +x script/base.sh
          HOMEBREW_NO_AUTO_UPDATE=1 ./script/install_dev_requirement.sh

      - name: Get current version
        id: version
        run: |
          CURRENT_VERSION=$(grep 'Version' internal/cli/version.go | awk '{print $3}' | sed 's/"//g')
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name: Calculate new version
        id: calculate
        run: |
          VERSION="${{ steps.version.outputs.current }}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          case "${{ github.event.inputs.version_type }}" in
            patch)
              NEW_PATCH=$((PATCH + 1))
              NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
              ;;
            minor)
              NEW_MINOR=$((MINOR + 1))
              NEW_VERSION="$MAJOR.$NEW_MINOR.0"
              ;;
            major)
              NEW_MAJOR=$((MAJOR + 1))
              NEW_VERSION="$NEW_MAJOR.0.0"
              ;;
          esac

          echo "new=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

      - name: Update version in version.go
        run: |
          sed -i '' 's/var Version = "${{ steps.version.outputs.current }}"/var Version = "${{ steps.calculate.outputs.new }}"/' internal/cli/version.go
          cat internal/cli/version.go

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit version change
        run: |
          case "${{ github.event.inputs.version_type }}" in
            patch)
              COMMIT_MSG=":bookmark: new patch version"
              ;;
            minor)
              COMMIT_MSG=":bookmark: new minor version"
              ;;
            major)
              COMMIT_MSG=":bookmark: new major version"
              ;;
          esac
          git add internal/cli/version.go
          git commit -m "$COMMIT_MSG"
          git push origin master

      - name: Create and push tag
        run: |
          git tag "v${{ steps.calculate.outputs.new }}"
          git push origin "v${{ steps.calculate.outputs.new }}"

      - name: Precheck
        run: |
          just precheck

      - name: Generate docs
        run: |
          just gendocs

      - name: Run tests
        run: |
          just test

      - name: Check version
        run: |
          just check

      - name: Generate release files
        run: |
          just genrelease

      - name: Create Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ github.event.inputs.pre_release }}" = "true" ]; then
            gh release create "v${{ steps.calculate.outputs.new }}" \
              --prerelease \
              --title "v${{ steps.calculate.outputs.new }}" \
              --notes "Release v${{ steps.calculate.outputs.new }}" \
              build/*
          else
            gh release create "v${{ steps.calculate.outputs.new }}" \
              --title "v${{ steps.calculate.outputs.new }}" \
              --notes "Release v${{ steps.calculate.outputs.new }}" \
              build/*
          fi
